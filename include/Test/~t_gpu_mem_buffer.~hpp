
#pragma once
#include <memory>

//#include "generatorgpu.h"
#include <iostream>
#include <vector>

#include "generator/generator_gpu.h"



namespace test {

class gpu_mem_buffer {
private:
    std::shared_ptr<radar::GeneratorGPU> gen_gpu_;

public:
    gpu_mem_buffer(const gpu_mem_buffer&) = default;
    gpu_mem_buffer(gpu_mem_buffer&&) = delete;
    gpu_mem_buffer& operator=(const gpu_mem_buffer&) = default;
    gpu_mem_buffer& operator=(gpu_mem_buffer&&) = delete;

    explicit gpu_mem_buffer(std::shared_ptr<radar::GeneratorGPU> gen_gpu)
        : gen_gpu_(gen_gpu) {}

    ~gpu_mem_buffer() {}

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âœ… ĞŸĞ Ğ˜ĞœĞ•Ğ  1 Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ«Ğ™: ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ‚Ñ€Ğ°Ğ½ÑÑ„ĞµÑ€ GPU â†’ CPU Ñ RAII
    // 
    // Ğ“Ğ›ĞĞ’ĞĞĞ• Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ•:
    // - Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ #2 Ñ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¼ GPU Ğ±ÑƒÑ„ĞµÑ€Ğ¾Ğ¼
    // - ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚ signal_gpu Ğ² ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ GPUMemoryBuffer
    // - Ğ§Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ¸Ğ· ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ“Ğ Ğ±ÑƒÑ„ĞµÑ€Ğ° (Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞ´Ñ€Ğ¾Ğ¼)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void Example1_FullTransfer_FIXED(const cl_mem& signal_gpu) {
        std::cout << "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
        std::cout << "âœ… ĞŸĞ Ğ˜ĞœĞ•Ğ  1 (Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ«Ğ™): ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ GPU â†’ CPU Ñ‚Ñ€Ğ°Ğ½ÑÑ„ĞµÑ€ Ñ RAII\n";
        std::cout << "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

        try {
            // âœ“ Ğ˜Ğ¡ĞŸĞ ĞĞ’ĞšĞ: ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ #2 Ñ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¼ GPU Ğ±ÑƒÑ„ĞµÑ€Ğ¾Ğ¼
            auto buffer = std::make_unique<gpu::GPUMemoryBuffer>(
                gen_gpu_->GetContext(),
                gen_gpu_->GetQueue(),
                signal_gpu,  // â† ĞĞĞ’Ğ«Ğ™ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€! ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ±ÑƒÑ„ĞµÑ€
                gen_gpu_->GetNumSamples() * gen_gpu_->GetNumBeams(),
                gpu::MemoryType::GPU_WRITE_ONLY
            );

            // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
            buffer->PrintStats();

            // âœ“ Ğ§Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ GPU â†’ CPU (Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¸Ğ· ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ“Ğ Ğ±ÑƒÑ„ĞµÑ€Ğ°!)
            std::vector<std::complex<float>> cpu_data = buffer->ReadFromGPU();

            // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
            std::cout << "ğŸ“Š First 10 samples (ray 0):\n";
            for (size_t i = 0; i < std::min(size_t(10), cpu_data.size()); ++i) {
                std::cout << " [" << i << "] = " << cpu_data[i].real()
                          << " + " << cpu_data[i].imag() << "j\n";
            }

            // âœ“ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾ÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğµ Ğ¸Ğ· Ğ¾Ğ±Ğ»Ğ°ÑÑ‚Ğ¸ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸

        } catch (const std::exception& e) {
            std::cerr << "âŒ Error: " << e.what() << "\n";
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ĞŸĞ Ğ˜ĞœĞ•Ğ  2: Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ N ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²) - Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void Example2_PartialRead_FIXED(const cl_mem& signal_gpu) {
        std::cout << "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
        std::cout << "âœ… ĞŸĞ Ğ˜ĞœĞ•Ğ  2 (Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ«Ğ™): Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ GPU â†’ CPU (10 ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²)\n";
        std::cout << "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

        try {
            // âœ“ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ #2 Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¼ Ğ±ÑƒÑ„ĞµÑ€Ğ¾Ğ¼
            auto buffer = std::make_unique<gpu::GPUMemoryBuffer>(
                gen_gpu_->GetContext(),
                gen_gpu_->GetQueue(),
                signal_gpu,  // â† Ğ’ĞĞ•Ğ¨ĞĞ˜Ğ™ Ğ±ÑƒÑ„ĞµÑ€
                gen_gpu_->GetNumSamples() * gen_gpu_->GetNumBeams(),
                gpu::MemoryType::GPU_WRITE_ONLY
            );

            // Ğ§Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 10 ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² (Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ!)
            std::vector<std::complex<float>> partial_data = buffer->ReadPartial(10);

            std::cout << "ğŸ“Š Partial data (10 samples):\n";
            for (size_t i = 0; i < partial_data.size(); ++i) {
                std::cout << " [" << i << "] = " << partial_data[i].real()
                          << " + " << partial_data[i].imag() << "j\n";
            }

        } catch (const std::exception& e) {
            std::cerr << "âŒ Error: " << e.what() << "\n";
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ĞŸĞ Ğ˜ĞœĞ•Ğ  3: Ğ”Ğ²ÑƒÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ½Ğ¸Ğ¹ Ñ‚Ñ€Ğ°Ğ½ÑÑ„ĞµÑ€ (CPU â†’ GPU â†’ CPU) - Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ
    // 
    // ĞŸĞ Ğ˜ĞœĞ•Ğ§ĞĞĞ˜Ğ•: Ğ”Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ #1 (Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹ Ğ±ÑƒÑ„ĞµÑ€)
    // Ñ‚.Ğº. Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğ° GPU
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void Example3_Bidirectional_FIXED() {
        std::cout << "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
        std::cout << "âœ… ĞŸĞ Ğ˜ĞœĞ•Ğ  3 (Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ«Ğ™): Ğ”Ğ²ÑƒÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ½Ğ¸Ğ¹ Ñ‚Ñ€Ğ°Ğ½ÑÑ„ĞµÑ€ CPU â†” GPU\n";
        std::cout << "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

        try {
            // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ #1 (ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ±ÑƒÑ„ĞµÑ€ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ°)
            auto buffer = std::make_unique<gpu::GPUMemoryBuffer>(
                gen_gpu_->GetContext(),
                gen_gpu_->GetQueue(),
                gen_gpu_->GetNumSamples() * gen_gpu_->GetNumBeams(),
                (cl_mem) nullptr,  // â† Ğ’ĞĞ•Ğ¨ĞĞ˜Ğ™ Ğ±ÑƒÑ„ĞµÑ€
                gpu::MemoryType::GPU_READ_WRITE
            );

            // 1. ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğ° CPU
            std::vector<std::complex<float>> test_data(buffer->GetNumElements());
            for (size_t i = 0; i < test_data.size(); ++i) {
                test_data[i] = std::complex<float>(
                    static_cast<float>(i),
                    static_cast<float>(i * 2)
                );
            }

            // 2. Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ½Ğ° GPU
            buffer->WriteToGPU(test_data);

            // 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğ° GPU "dirty"
            std::cout << "GPU Dirty flag: " << (buffer->IsGPUDirty() ? "Yes" : "No") << "\n";

            // 4. ĞŸÑ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ñ GPU
            std::vector<std::complex<float>> readback = buffer->ReadFromGPU();

            // 5. Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ
            std::cout << "\nğŸ“Š Data verification (first 5 elements):\n";
            bool all_match = true;
            for (size_t i = 0; i < std::min(size_t(5), readback.size()); ++i) {
                bool match = (test_data[i] == readback[i]);
                std::cout << " [" << i << "] Original: " << test_data[i]
                          << " Read: " << readback[i]
                          << " " << (match ? "âœ“" : "âœ—") << "\n";
                if (!match) all_match = false;
            }

            std::cout << "\n" << (all_match ? "âœ… All data matches!" : "âŒ Data mismatch!") << "\n";

        } catch (const std::exception& e) {
            std::cerr << "âŒ Error: " << e.what() << "\n";
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ĞŸĞ Ğ˜ĞœĞ•Ğ  4: Pool Ğ±ÑƒÑ„ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ - Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void Example4_BufferPool_FIXED() {
        std::cout << "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
        std::cout << "âœ… ĞŸĞ Ğ˜ĞœĞ•Ğ  4 (Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ«Ğ™): Pool Ğ±ÑƒÑ„ĞµÑ€Ğ¾Ğ²\n";
        std::cout << "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

        try {
            size_t num_buffers = 3;
            std::vector<std::unique_ptr<gpu::GPUMemoryBuffer>> buffer_pool;

            // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ pool Ğ±ÑƒÑ„ĞµÑ€Ğ¾Ğ² (ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑĞ¾ ÑĞ²Ğ¾ĞµĞ¹ Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒÑ)
            for (size_t i = 0; i < num_buffers; ++i) {
                buffer_pool.push_back(
                    std::make_unique<gpu::GPUMemoryBuffer>(
                        gen_gpu_->GetContext(),
                        gen_gpu_->GetQueue(),
                        gen_gpu_->GetNumSamples() * gen_gpu_->GetNumBeams(),
                        gpu::MemoryType::GPU_READ_WRITE
                    )
                );
                std::cout << "Created buffer " << i + 1 << "/" << num_buffers << "\n";
            }

            // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±ÑƒÑ„ĞµÑ€Ñ‹
            for (size_t i = 0; i < buffer_pool.size(); ++i) {
                std::cout << "\nBuffer " << i << " info:\n";
                buffer_pool[i]->PrintStats();
            }

            std::cout << "\nâœ… Total GPU memory: "
                      << (buffer_pool.size() * buffer_pool[0]->GetTotalBytes() / (1024.0 * 1024.0))
                      << " MB\n";

        } catch (const std::exception& e) {
            std::cerr << "âŒ Error: " << e.what() << "\n";
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âœ… ĞŸĞ Ğ˜ĞœĞ•Ğ  5 Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ«Ğ™: Ğ—Ğ°Ğ¼ĞµĞ½Ğ° Ğ´Ğ»Ñ gpu_to_cpu Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
    // 
    // Ğ Ğ•ĞšĞĞœĞ•ĞĞ”Ğ£Ğ•ĞœĞ«Ğ™ ĞŸĞĞ”Ğ¥ĞĞ” Ğ´Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ!
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    void Example5_ReplacementForGpuToCpu_FIXED(const cl_mem& signal_gpu) {
        std::cout << "\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
        std::cout << "âœ… ĞŸĞ Ğ˜ĞœĞ•Ğ  5 (Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ«Ğ™): Ğ—Ğ°Ğ¼ĞµĞ½Ğ° gpu_to_cpu Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸\n";
        std::cout << "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

        try {
            // ĞĞĞ’Ğ«Ğ™ ĞŸĞĞ”Ğ¥ĞĞ” Ñ ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€Ğ¾Ğ¼ #2
            // ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ GPU Ğ±ÑƒÑ„ĞµÑ€ Ğ² GPUMemoryBuffer
            auto buffer = std::make_unique<gpu::GPUMemoryBuffer>(
                gen_gpu_->GetContext(),
                gen_gpu_->GetQueue(),
                signal_gpu,  // â† Ğ“Ğ›ĞĞ’ĞĞĞ•: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ“ĞĞ¢ĞĞ’Ğ«Ğ™ Ğ±ÑƒÑ„ĞµÑ€!
                gen_gpu_->GetNumSamples() * gen_gpu_->GetNumBeams(),
                gpu::MemoryType::GPU_WRITE_ONLY
            );

            // Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾ Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ (ĞºĞ°Ğº Ğ² ÑÑ‚Ğ°Ñ€Ğ¾Ğ¹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ gpu_to_cpu)
            size_t read_samples = std::min(size_t(10), gen_gpu_->GetNumSamples());
            std::vector<std::complex<float>> cpu_data = buffer->ReadPartial(read_samples);

            std::cout << "ğŸ“¤ Ğ¢Ñ€Ğ°Ğ½ÑÑ„ĞµÑ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… GPU â†’ CPU (Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ»ÑƒÑ‡, Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ "
                      << read_samples << " Ğ¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ğ¾Ğ² signal_base):\n";

            for (size_t i = 0; i < cpu_data.size(); ++i) {
                std::cout << " [" << i << "] = " << cpu_data[i].real()
                          << " + " << cpu_data[i].imag() << "j\n";
            }

        } catch (const std::exception& e) {
            std::cerr << "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğ¸ Ğ¸Ğ· GPU: " << e.what() << "\n";
        }
    }
};

}  // namespace test

/**
 * 
 * 
 * 
 */