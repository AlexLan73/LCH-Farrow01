# Архитектурные диаграммы: HIP ↔ OpenCL Interop

---

## 1. Общая архитектура системы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              APPLICATION                                     │
│                                                                              │
│  ┌──────────────────────┐              ┌──────────────────────┐              │
│  │   OpenCL Components  │              │    HIP Components    │              │
│  │   ─────────────────  │              │    ──────────────    │              │
│  │   • FFT (clFFT)      │              │    • rocBLAS         │              │
│  │   • Preprocessing    │              │    • rocSOLVER       │              │
│  │   • Filtering        │              │    • Custom kernels  │              │
│  └──────────┬───────────┘              └───────────┬──────────┘              │
│             │                                      │                         │
│             │         ┌────────────────────┐       │                         │
│             └────────►│   SVM Memory Ptr   │◄──────┘                         │
│                       │   (clSVMAlloc)     │                                 │
│                       └─────────┬──────────┘                                 │
└─────────────────────────────────┼───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            AMD ROCm Runtime                                  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                              HSA Runtime                               │  │
│  │   (Heterogeneous System Architecture - общая основа HIP и OpenCL)     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              GPU HARDWARE                                    │
│                            AMD Instinct MI100                                │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                           HBM2 Memory                                  │  │
│  │                                                                        │  │
│  │   ┌───────────────────────────────────────────────────────────────┐   │  │
│  │   │                    SVM Buffer Region                           │   │  │
│  │   │                                                                │   │  │
│  │   │    ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐            │   │  │
│  │   │    │ Vec 0   │ │ Vec 1   │ │ Vec 2   │ │   ...   │            │   │  │
│  │   │    │ Complex │ │ Complex │ │ Complex │ │         │            │   │  │
│  │   │    └─────────┘ └─────────┘ └─────────┘ └─────────┘            │   │  │
│  │   │                                                                │   │  │
│  │   └───────────────────────────────────────────────────────────────┘   │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Data Flow Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PROCESSING PIPELINE                                  │
│                                                                              │
│  ┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │
│  │  INPUT  │    │   OpenCL    │    │     HIP     │    │   OUTPUT    │       │
│  │  (CPU)  │───►│  FFT/Prep   │───►│   Matrix    │───►│    (CPU)    │       │
│  └─────────┘    │             │    │   Invert    │    └─────────────┘       │
│       │         └──────┬──────┘    └──────┬──────┘           │              │
│       │                │                  │                   │              │
│       ▼                ▼                  ▼                   ▼              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         SVM Buffer (GPU)                             │    │
│  │                                                                      │    │
│  │   CPU Copy    OpenCL        HIP         OpenCL       CPU Copy        │    │
│  │   IN ──►──►── Kernel ──►── Kernel ──►── Kernel ──►──►── OUT         │    │
│  │                                                                      │    │
│  │   ════════════════════════════════════════════════════════════       │    │
│  │            NO COPIES BETWEEN GPU OPERATIONS!                         │    │
│  │   ════════════════════════════════════════════════════════════       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Memory Model Comparison

### БЕЗ SVM (старый подход) ❌

```
┌──────────┐      ┌──────────┐      ┌──────────┐      ┌──────────┐
│   CPU    │      │   GPU    │      │   CPU    │      │   GPU    │
│  Memory  │─────►│ OpenCL   │─────►│  Memory  │─────►│   HIP    │
│          │ copy │  Buffer  │ copy │          │ copy │  Buffer  │
└──────────┘      └──────────┘      └──────────┘      └──────────┘
     │                 │                 │                 │
     └─── 32MB ───────►└─── 32MB ───────►└─── 32MB ───────►│
                                                           │
                    Total: 96 MB transferred!              │
                    Latency: ~60ms for 4M floats          │
```

### С SVM (новый подход) ✅

```
┌──────────┐      ┌───────────────────────────────────────┐      ┌──────────┐
│   CPU    │      │              GPU Memory               │      │   CPU    │
│  Memory  │─────►│                                       │─────►│  Memory  │
│          │ 32MB │  ┌─────────────────────────────────┐  │ 32MB │          │
└──────────┘      │  │         SVM Buffer              │  │      └──────────┘
                  │  │                                 │  │
                  │  │  OpenCL ──► HIP ──► OpenCL     │  │
                  │  │    ▲          ▲         ▲       │  │
                  │  │    │          │         │       │  │
                  │  │    └────NO COPIES───────┘       │  │
                  │  │                                 │  │
                  │  └─────────────────────────────────┘  │
                  │                                       │
                  └───────────────────────────────────────┘
                  
                  Total: 64 MB transferred (IN + OUT only)
                  GPU operations: 0 MB transferred!
```

---

## 4. Synchronization Points

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        SYNCHRONIZATION FLOW                              │
│                                                                          │
│   Time ──────────────────────────────────────────────────────────►       │
│                                                                          │
│   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐             │
│   │ OpenCL   │   │ OpenCL   │   │   HIP    │   │   HIP    │             │
│   │ Kernel 1 │   │ Kernel 2 │   │ Kernel 1 │   │ Kernel 2 │             │
│   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘             │
│        │              │              │              │                    │
│        ▼              ▼              ▼              ▼                    │
│   ──────────────────────────────────────────────────────────            │
│        │              │              │              │                    │
│        │         clFinish()    hipSync()      hipSync()                 │
│        │              │              │              │                    │
│        │              │              │              │                    │
│   ═════╪══════════════╪══════════════╪══════════════╪═══════            │
│        │              │              │              │                    │
│   SVM  │   write      │   write      │   write      │   write           │
│   Buf  └──────────────┴──────────────┴──────────────┴─────►             │
│                                                                          │
│   RULE: Always synchronize when switching between APIs!                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Class Diagram (предлагаемая реализация)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           SVMInteropManager                              │
├─────────────────────────────────────────────────────────────────────────┤
│ - cl_context ctx_                                                        │
│ - cl_command_queue queue_                                                │
│ - cl_device_id device_                                                   │
│ - std::vector<void*> allocated_buffers_                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ + SVMInteropManager(int device_id)                                       │
│ + ~SVMInteropManager()                                                   │
│ + void* allocate(size_t size)                                            │
│ + void free(void* ptr)                                                   │
│ + void syncOpenCL()                                                      │
│ + void syncHIP()                                                         │
│ + cl_context getContext()                                                │
│ + cl_command_queue getQueue()                                            │
├─────────────────────────────────────────────────────────────────────────┤
│ // Static helpers                                                        │
│ + static bool isSVMSupported(cl_device_id device)                        │
│ + static size_t getOptimalAlignment(cl_device_id device)                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ uses
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           ComplexVector                                  │
├─────────────────────────────────────────────────────────────────────────┤
│ - SVMInteropManager& manager_                                            │
│ - Complex* data_                                                         │
│ - size_t size_                                                           │
├─────────────────────────────────────────────────────────────────────────┤
│ + ComplexVector(SVMInteropManager& mgr, size_t n)                        │
│ + ~ComplexVector()                                                       │
│ + Complex* data()                                                        │
│ + size_t size()                                                          │
│ + void copyFromHost(const Complex* host_data)                            │
│ + void copyToHost(Complex* host_data)                                    │
│ + operator rocblas_float_complex*()                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Deployment View

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              System                                      │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        Application Process                         │ │
│  │                                                                    │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │ │
│  │  │ libOpenCL.so │  │  libhip.so   │  │    librocblas.so         │ │ │
│  │  │              │  │              │  │    librocsolver.so       │ │ │
│  │  └──────┬───────┘  └──────┬───────┘  └────────────┬─────────────┘ │ │
│  │         │                 │                       │               │ │
│  └─────────┼─────────────────┼───────────────────────┼───────────────┘ │
│            │                 │                       │                 │
│            ▼                 ▼                       ▼                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     ROCm Runtime (HSA)                          │   │
│  │                     /opt/rocm/lib/                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                │                                       │
│                                ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     AMD GPU Driver (amdgpu)                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                │                                       │
└────────────────────────────────┼───────────────────────────────────────┘
                                 │
                                 ▼
                    ┌──────────────────────┐
                    │   AMD Instinct MI100 │
                    │   (gfx908)           │
                    └──────────────────────┘
```

