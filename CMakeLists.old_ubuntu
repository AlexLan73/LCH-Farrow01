
cmake_minimum_required(VERSION 3.20)


project(LCH-Farrow VERSION 1.0.0 LANGUAGES CXX)

# ============================================================================
# –ß–ê–°–¢–¨ 0: –î–ï–¢–ï–ö–¶–ò–Ø GPU –ò CUDA
# ============================================================================

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ GPU
# –î–ª—è Ubuntu –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º OpenCL
if(UNIX AND NOT APPLE)
    option(ENABLE_CUDA "Enable CUDA support" OFF)
    option(ENABLE_OPENCL "Enable OpenCL support" ON)
else()
    option(ENABLE_CUDA "Enable CUDA support" ON)
    option(ENABLE_OPENCL "Enable OpenCL support" OFF)
endif()

################################################################################
# GPU Type Detection
################################################################################
# –°–Ω–∞—á–∞–ª–∞ –æ–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ CUDA_ARCH

# –í–ê–ñ–ù–û: –û–±—ä—è–≤–ª—è–µ–º –∫–∞–∫ option() —á—Ç–æ–±—ã CMakePresets –º–æ–≥ –ø–µ—Ä–µ–¥–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
option(TYPE_GPU "GPU Type (e.g., RTX 2080ti, RTX 3060, A100, V100)" "")
# –í–ê–ñ–ù–û: –û–±—ä—è–≤–ª—è–µ–º –∫–∞–∫ option() —á—Ç–æ–±—ã CMakePresets –º–æ–≥ –ø–µ—Ä–µ–¥–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ

message(STATUS "DEBUG: TYPE_GPU from CMakePresets = '${TYPE_GPU}'")
message(STATUS "DEBUG: CUDA_ARCH = '${CUDA_ARCH}'")

mark_as_advanced(TYPE_GPU)

# –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –°–ù–ê–ß–ê–õ–ê –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ CMakePresets (—É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ)
# –ï—Å–ª–∏ –æ–Ω–æ –ø—É—Å—Ç–æ–µ - —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞ auto-detect –ø–æ CUDA_ARCH
if(NOT TYPE_GPU OR TYPE_GPU STREQUAL "")
    # Auto-detect –ø–æ CUDA_ARCH –µ—Å–ª–∏ TYPE_GPU –Ω–µ –∑–∞–¥–∞–Ω –≤ CMakePresets
    if(CUDA_ARCH MATCHES "75")
        set(TYPE_GPU "RTX 2080 / RTX 2080ti")
    elseif(CUDA_ARCH MATCHES " 80|88|89")
        set(TYPE_GPU "A100 / RTX 30690")
    elseif(CUDA_ARCH MATCHES "70")
        set(TYPE_GPU "V100 / Tesla P100")
    else()
        set(TYPE_GPU "Unknown / Auto-detect")
    endif()
endif()

# message(STATUS "üéÆ GPU TYPE: ${TYPE_GPU}")


option(CUDA_ARCH "CUDA architecture (default: auto-detect)" "")

# –û–ø—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é (bundled) —Å–±–æ—Ä–∫—É clFFT –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–Ω–∞—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
option(USE_BUNDLED_CLFFT "Download and build clFFT if not found" ON)

# ============================================================================
# –ß–ê–°–¢–¨ 0: –î–ï–¢–ï–ö–¶–ò–Ø GPU –ò CUDA
# ============================================================================

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ GPU
option(ENABLE_CUDA "Enable CUDA support" ON)
option(ENABLE_OPENCL "Enable OpenCL support" OFF)
option(CUDA_ARCH "CUDA architecture (default: auto-detect)" "")

# ‚úÖ –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û - –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è TYPE_GPU
set(TYPE_GPU "" CACHE STRING "GPU Type (e.g., RTX 2080ti, V100, A100)")

# ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å GPU –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
if(TYPE_GPU STREQUAL "")
    if(CUDA_ARCH MATCHES "75")
        set(TYPE_GPU "RTX 2080/2080ti")
    elseif(CUDA_ARCH MATCHES "80")
        set(TYPE_GPU "A100 / RTX 3090")
    elseif(CUDA_ARCH MATCHES "70")
        set(TYPE_GPU "V100")
    else()
        set(TYPE_GPU "Unknown/Auto-detect")
    endif()
endif()

message(STATUS "üéÆ GPU TYPE: ${TYPE_GPU}")




message(STATUS "")
message(STATUS "üéÆ GPU SUPPORT OPTIONS:")
message(STATUS "   ENABLE_CUDA: ${ENABLE_CUDA}")
message(STATUS "   ENABLE_OPENCL: ${ENABLE_OPENCL}")
message(STATUS "")

# –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ CUDA
if(ENABLE_CUDA)
    find_package(CUDA QUIET)
    if(CUDA_FOUND)
        message(STATUS "‚úÖ CUDA –ù–ê–ô–î–ï–ù–ê!")
        message(STATUS "   CUDA Version: ${CUDA_VERSION}")
        message(STATUS "   CUDA Toolkit: ${CUDA_TOOLKIT_ROOT_DIR}")
        message(STATUS "   CUDA Include: ${CUDA_INCLUDE_DIRS}")
        
        # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å GPU –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
        if(CUDA_ARCH STREQUAL "")
            # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            message(STATUS "üîç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ GPU –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã...")
            execute_process(
                COMMAND ${CUDA_TOOLKIT_ROOT_DIR}/extras/demo_suite/deviceQuery
                OUTPUT_VARIABLE CUDA_DEVICE_QUERY
                ERROR_QUIET
            )
            
            # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
            if(NOT CUDA_DEVICE_QUERY)
                message(STATUS "‚ö†Ô∏è  deviceQuery –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã")
                set(CUDA_ARCH "70;75;80")  # V100, RTX 2080, A100
            else()
                message(STATUS "üìä GPU Info:")
                message(STATUS "${CUDA_DEVICE_QUERY}")
            endif()
        endif()
        
        message(STATUS "   Target CUDA Arch: ${CUDA_ARCH}")
        set(CUDA_ENABLED TRUE)
    else()
        message(STATUS "‚ö†Ô∏è  CUDA –ù–ï –ù–ê–ô–î–ï–ù–ê")
        message(STATUS "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ CUDA Toolkit: https://developer.nvidia.com/cuda-toolkit")
        message(STATUS "   –ò–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ CUDA: -DENABLE_CUDA=OFF")
        set(CUDA_ENABLED FALSE)
    endif()
else()
    message(STATUS "‚è≠Ô∏è  CUDA –æ—Ç–∫–ª—é—á–µ–Ω–∞ (ENABLE_CUDA=OFF)")
    set(CUDA_ENABLED FALSE)
endif()

# –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ OpenCL
if(ENABLE_OPENCL)
    find_package(OpenCL REQUIRED)
    if(OpenCL_FOUND)
        message(STATUS "‚úÖ OpenCL –ù–ê–ô–î–ï–ù–ê!")
        message(STATUS "   OpenCL Version: ${OpenCL_VERSION_STRING}")
        message(STATUS "   OpenCL Include: ${OpenCL_INCLUDE_DIRS}")
        message(STATUS "   OpenCL Libraries: ${OpenCL_LIBRARIES}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ OpenCL (—Ç—Ä–µ–±—É–µ—Ç—Å—è >= 2.0)
        if(OpenCL_VERSION_STRING VERSION_LESS "2.0")
            message(WARNING "‚ö†Ô∏è  OpenCL –≤–µ—Ä—Å–∏—è ${OpenCL_VERSION_STRING} < 2.0, –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º—ã")
        endif()
        
        # –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø–æ—Å—Ç–∞–≤–∫—É clFFT –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
        if(EXISTS "${CMAKE_SOURCE_DIR}/clFFT/include")
            set(CLFFT_INCLUDE_DIR "${CMAKE_SOURCE_DIR}/clFFT/include")
            message(STATUS "‚úÖ Using local clFFT include: ${CLFFT_INCLUDE_DIR}")
        endif()

        if(EXISTS "${CMAKE_SOURCE_DIR}/clFFT/lib/x64")
            if(MSVC)
                set(CLFFT_LIBRARY "${CMAKE_SOURCE_DIR}/clFFT/lib/x64/clFFT.lib")
            else()
                set(CLFFT_LIBRARY "${CMAKE_SOURCE_DIR}/clFFT/lib/x64/libclFFT.a")
            endif()
            if(EXISTS "${CLFFT_LIBRARY}")
                message(STATUS "‚úÖ Using local clFFT library: ${CLFFT_LIBRARY}")
            else()
                unset(CLFFT_LIBRARY)
            endif()
        endif()

        # –ü–æ–∏—Å–∫ clFFT –≤ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—É—Ç—è—Ö —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è
        if(NOT CLFFT_INCLUDE_DIR)
            find_path(CLFFT_INCLUDE_DIR
                NAMES clFFT.h
                PATHS /usr/local/include /usr/include
                PATH_SUFFIXES clFFT
            )
        endif()

        if(NOT CLFFT_LIBRARY)
            find_library(CLFFT_LIBRARY
                NAMES clFFT
                PATHS /usr/local/lib /usr/lib /usr/lib/x86_64-linux-gnu
            )
        endif()
        
        if(CLFFT_INCLUDE_DIR AND CLFFT_LIBRARY)
            message(STATUS "‚úÖ clFFT –ù–ê–ô–î–ï–ù–ê!")
            message(STATUS "   clFFT Library: ${CLFFT_LIBRARY}")
            message(STATUS "   clFFT Include: ${CLFFT_INCLUDE_DIR}")
            set(CLFFT_FOUND TRUE)
        else()
            message(WARNING "‚ö†Ô∏è  clFFT –ù–ï –ù–ê–ô–î–ï–ù–ê!")
            # –ü–æ–ø—Ä–æ–±—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∞—Ç—å –∏ —Å–æ–±—Ä–∞—Ç—å clFFT —Å –ø–æ–º–æ—â—å—é FetchContent
            if(USE_BUNDLED_CLFFT)
                message(STATUS "‚è¨ –ü–æ–ø—Ä–æ–±—É–µ–º —Å–∫–∞—á–∞—Ç—å –∏ —Å–æ–±—Ä–∞—Ç—å clFFT (USE_BUNDLED_CLFFT=ON)")
                include(FetchContent)
                FetchContent_Declare(
                    clFFT
                    GIT_REPOSITORY https://github.com/clMathLibraries/clFFT.git
                    GIT_TAG master
                )
                FetchContent_GetProperties(clFFT)
                if(NOT clFFT_POPULATED)
                    FetchContent_Populate(clFFT)
                endif()

                # –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é clFFT –∫–∞–∫ –≤–Ω–µ—à–Ω–∏–π –ø—Ä–æ–µ–∫—Ç
                if(EXISTS "${clFFT_SOURCE_DIR}/CMakeLists.txt")
                    add_subdirectory(${clFFT_SOURCE_DIR} ${clFFT_BINARY_DIR} EXCLUDE_FROM_ALL)
                    # –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ü–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è clFFT –∏–ª–∏ clFFT::clFFT
                    if(TARGET clFFT)
                        set(CLFFT_LIBRARY clFFT)
                        set(CLFFT_INCLUDE_DIR "${clFFT_SOURCE_DIR}/inc")
                        set(CLFFT_FOUND TRUE)
                        message(STATUS "‚úÖ clFFT —Å–æ–±—Ä–∞–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –∫–∞–∫ target 'clFFT'")
                    elseif(TARGET clFFT::clFFT)
                        set(CLFFT_LIBRARY clFFT::clFFT)
                        set(CLFFT_INCLUDE_DIR "${clFFT_SOURCE_DIR}/inc")
                        set(CLFFT_FOUND TRUE)
                        message(STATUS "‚úÖ clFFT —Å–æ–±—Ä–∞–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –∫–∞–∫ target 'clFFT::clFFT'")
                    else()
                        message(WARNING "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å clFFT –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤; –æ—Å—Ç–∞–≤–ª—è–µ–º CLFFT_FOUND=FALSE")
                        set(CLFFT_FOUND FALSE)
                    endif()
                else()
                    message(WARNING "–ò—Å—Ö–æ–¥–Ω–∏–∫–∏ clFFT –Ω–µ —Å–∫–∞—á–∞–Ω—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç: ${clFFT_SOURCE_DIR}")
                    set(CLFFT_FOUND FALSE)
                endif()
            else()
                message(STATUS "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: sudo apt install libclfft-dev")
                message(STATUS "   FFT –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ CPU (–≤—Ä–µ–º–µ–Ω–Ω–æ)")
                set(CLFFT_FOUND FALSE)
            endif()
        endif()
        
        set(OPENCL_ENABLED TRUE)
    else()
        message(FATAL_ERROR "‚ùå OpenCL –ù–ï –ù–ê–ô–î–ï–ù–ê! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ OpenCL SDK")
    endif()
else()
    message(STATUS "‚è≠Ô∏è  OpenCL –æ—Ç–∫–ª—é—á–µ–Ω–∞ (ENABLE_OPENCL=OFF)")
    set(OPENCL_ENABLED FALSE)
    set(CLFFT_FOUND FALSE)
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 1: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –û–ü–ï–†–ê–¶–ò–û–ù–ù–û–ô –°–ò–°–¢–ï–ú–´
# ============================================================================

if(WIN32)
    set(IS_WINDOWS TRUE)
    set(IS_LINUX FALSE)
    set(PLATFORM_NAME "Windows")
    message(STATUS "ü™ü –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: WINDOWS")
    
elseif(UNIX AND NOT APPLE)
    set(IS_LINUX TRUE)
    set(IS_WINDOWS FALSE)
    set(PLATFORM_NAME "Linux")
    message(STATUS "üêß –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: LINUX")
    
elseif(APPLE)
    set(IS_LINUX TRUE)
    set(IS_WINDOWS FALSE)
    set(PLATFORM_NAME "macOS")
    message(STATUS "üçé –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: macOS")
    
else()
    message(FATAL_ERROR "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞!")
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 2: –í–ï–†–°–ò–Ø –ò –°–¢–ê–ù–î–ê–†–¢–´ C++
# ============================================================================

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

message(STATUS "C++ Standard: C++17")
message(STATUS "Compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")

# ============================================================================
# –ß–ê–°–¢–¨ 3: –ü–ê–†–ê–ú–ï–¢–†–´ –°–ë–û–†–ö–ò
# ============================================================================

# –î–ª—è multi-config –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ (Visual Studio) CMAKE_BUILD_TYPE –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
# CLion –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ --config Debug/Release
if(NOT CMAKE_BUILD_TYPE AND NOT CMAKE_CONFIGURATION_TYPES)
    set(CMAKE_BUILD_TYPE Release)
endif()

if(CMAKE_CONFIGURATION_TYPES)
    message(STATUS "Build Type: Multi-config (Debug/Release) - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ --config")
else()
    message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 4: –ö–û–ú–ü–ò–õ–Ø–¢–û–† –ò –§–õ–ê–ì–ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò
# ============================================================================

if(MSVC)
    # ===== WINDOWS (MSVC –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä) =====
    message(STATUS "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: MSVC (Visual Studio)")
    
    # –§–ª–∞–≥–∏ –¥–ª—è Debug —Ä–µ–∂–∏–º–∞ (–æ—Ç–ª–∞–¥–∫–∞)
    set(CMAKE_CXX_FLAGS_DEBUG "/MDd /Zi /Od /RTC1 /DEBUG")
    # –§–ª–∞–≥–∏ –¥–ª—è Release —Ä–µ–∂–∏–º–∞ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
    set(CMAKE_CXX_FLAGS_RELEASE "/MD /O2 /Oi /arch:AVX2 /DNDEBUG")
    # –î–ª—è RelWithDebInfo (Release —Å –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π)
    set(CMAKE_CXX_FLAGS_RELWITHDEBINFO "/MD /O2 /Zi /DNDEBUG")
    
    add_compile_options(
        /W4
        /EHsc
        /permissive-
        /Zc:inline
    )
    
    add_compile_definitions(
        _CRT_SECURE_NO_WARNINGS
        _CRT_NONSTDC_NO_WARNINGS
    )
    
    message(STATUS "Compiler: MSVC ${MSVC_VERSION}")
    message(STATUS "Optimization: /O2 /arch:AVX2")
    
else()
    # ===== LINUX / WSL / macOS (GCC / Clang) =====
    if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
        message(STATUS "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: GCC")
        set(COMPILER_NAME "GCC")
    elseif(CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
        message(STATUS "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: Clang")
        set(COMPILER_NAME "Clang")
    else()
        message(STATUS "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ${CMAKE_CXX_COMPILER_ID}")
        set(COMPILER_NAME "${CMAKE_CXX_COMPILER_ID}")
    endif()
    
    set(CMAKE_CXX_FLAGS_DEBUG "-g -ggdb3 -O0 -Wall -Wextra -Wpedantic")
    set(CMAKE_CXX_FLAGS_RELEASE "-O3 -march=native -mtune=native -Wall")
    
    add_compile_options(
        -Wall
        -Wextra
        -Wpedantic
        -ffast-math
        -funroll-loops
    )
    
    message(STATUS "Compiler: ${COMPILER_NAME}")
    message(STATUS "Optimization: -O3 -march=native")
    
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 5: –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê
# ============================================================================

message(STATUS "")
message(STATUS "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:")
message(STATUS "   Source dir: ${CMAKE_SOURCE_DIR}")
message(STATUS "   Build dir: ${CMAKE_BINARY_DIR}")
message(STATUS "")

set(SOURCES
    src/main.cpp
    src/mylib.cpp
    # OOP refactor sources
    src/application.cpp
    src/signal_generator.cpp
    src/gpu_processor.cpp
    src/validator.cpp
    src/reporter.cpp
)

set(HEADERS
    include/mylib.h
)

# –î–æ–±–∞–≤–∏—Ç—å CUDA —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞
if(CUDA_ENABLED)
    list(APPEND SOURCES
        src/gpu_kernel.cu
    )
    list(APPEND HEADERS
        include/gpu_kernel.h
    )
    message(STATUS "‚úÖ CUDA –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")
endif()

# –î–æ–±–∞–≤–∏—Ç—å OpenCL —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞
if(OPENCL_ENABLED)
    list(APPEND SOURCES
        src/signal_buffer.cpp
        src/filter_bank.cpp
        src/processing_pipeline.cpp
        src/profiling_engine.cpp
        src/lagrange_matrix.cpp
        src/lfm_signal_generator.cpp
        src/gpu_backend/opencl_backend.cpp
        src/gpu_backend/gpu_factory.cpp
        src/fractional_delay_cpu.cpp
        src/result_comparator.cpp
        src/gpu_profiling.cpp
        src/generator/generator_gpu.cpp
    )
    list(APPEND HEADERS
        include/signal_buffer.h
        include/filter_bank.h
        include/processing_pipeline.h
        include/profiling_engine.h
        include/lagrange_matrix.h
        include/lfm_signal_generator.h
        include/gpu_backend/igpu_backend.h
        include/gpu_backend/opencl_backend.h
        include/gpu_backend/gpu_factory.h
        include/fractional_delay_cpu.h
        include/result_comparator.h
        include/gpu_profiling.h
        include/generator/generator_gpu.h
    )
    message(STATUS "‚úÖ OpenCL –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 6: –°–û–ó–î–ê–ù–ò–ï –ò–°–ü–û–õ–ù–Ø–ï–ú–û–ì–û –§–ê–ô–õ–ê
# ============================================================================

if(CUDA_ENABLED)
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CUDA –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
    enable_language(CUDA)
    set(CMAKE_CUDA_STANDARD 17)
    set(CMAKE_CUDA_STANDARD_REQUIRED ON)
    
    add_executable(${PROJECT_NAME} ${SOURCES})
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å CUDA –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
    if(NOT CUDA_ARCH STREQUAL "")
        set_target_properties(${PROJECT_NAME} PROPERTIES
            CUDA_ARCHITECTURES ${CUDA_ARCH}
        )
    endif()
    
    message(STATUS "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CUDA –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –¥–ª—è GPU –∫–æ–¥–∞")
else()
    add_executable(${PROJECT_NAME} ${SOURCES})
endif()

# –ü–æ–¥–∫–ª—é—á–∏—Ç—å include –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
target_include_directories(${PROJECT_NAME} 
    PRIVATE 
    ${CMAKE_SOURCE_DIR}/include
)

# –ï—Å–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–ø–∏–∏ clFFT/OpenCL headers, –ø–æ–¥–∫–ª—é—á–∏–º –∏—Ö
if(EXISTS "${CMAKE_SOURCE_DIR}/clFFT/include")
    message(STATUS "‚úÖ Local clFFT include found: ${CMAKE_SOURCE_DIR}/clFFT/include")
    target_include_directories(${PROJECT_NAME} PRIVATE "${CMAKE_SOURCE_DIR}/clFFT/include")
endif()

# –õ–æ–∫–∞–ª—å–Ω–∞—è clFFT —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤—ã—à–µ (CLFFT_INCLUDE_DIR / CLFFT_LIBRARY)
# ============================================================================
# –ß–ê–°–¢–¨ 7: –õ–ò–ù–ö–û–í–ö–ê –ò –ó–ê–í–ò–°–ò–ú–û–°–¢–ò
# ============================================================================

if(NOT MSVC)
    target_link_libraries(${PROJECT_NAME} PRIVATE m)
endif()

# –õ–∏–Ω–∫–æ–≤–∫–∞ CUDA
if(CUDA_ENABLED)
    target_link_libraries(${PROJECT_NAME} PRIVATE ${CUDA_LIBRARIES})
    target_include_directories(${PROJECT_NAME} PRIVATE ${CUDA_INCLUDE_DIRS})
    target_compile_definitions(${PROJECT_NAME} PRIVATE CUDA_ENABLED=1)
    message(STATUS "‚úÖ CUDA –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ª–∏–Ω–∫–æ–≤–∫—É")
endif()

# –õ–∏–Ω–∫–æ–≤–∫–∞ OpenCL
if(OPENCL_ENABLED)
    target_link_libraries(${PROJECT_NAME} PRIVATE OpenCL::OpenCL)
    target_include_directories(${PROJECT_NAME} PRIVATE 
        ${CMAKE_SOURCE_DIR}/include
        ${OpenCL_INCLUDE_DIRS}
    )
    
    # –î–æ–±–∞–≤–∏—Ç—å clFFT –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞
    if(CLFFT_FOUND)
        target_link_libraries(${PROJECT_NAME} PRIVATE ${CLFFT_LIBRARY})
        target_include_directories(${PROJECT_NAME} PRIVATE ${CLFFT_INCLUDE_DIR})
        target_compile_definitions(${PROJECT_NAME} PRIVATE 
            OPENCL_ENABLED=1
            CLFFT_FOUND=1
        )
        message(STATUS "‚úÖ clFFT –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –ª–∏–Ω–∫–æ–≤–∫—É")
    else()
        target_compile_definitions(${PROJECT_NAME} PRIVATE 
            OPENCL_ENABLED=1
            CLFFT_FOUND=0
        )
    endif()
    
    # –î–æ–±–∞–≤–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å kernel —Ñ–∞–π–ª–∞–º–∏
    set(OPENCL_KERNEL_DIR "${CMAKE_SOURCE_DIR}/kernels")
    target_compile_definitions(${PROJECT_NAME} PRIVATE 
        OPENCL_KERNEL_DIR="${OPENCL_KERNEL_DIR}"
    )
    
    message(STATUS "‚úÖ OpenCL –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ª–∏–Ω–∫–æ–≤–∫—É")
    message(STATUS "   OpenCL Kernel Dir: ${OPENCL_KERNEL_DIR}")
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 8: –û–ü–¶–ò–ò –ö–û–ú–ü–ò–õ–Ø–¶–ò–ò –î–õ–Ø –¶–ï–õ–ò
# ============================================================================

if(MSVC)
    target_compile_options(${PROJECT_NAME} 
        PRIVATE 
        /arch:AVX2
        /Gy
        /fp:precise
    )
else()
    target_compile_options(${PROJECT_NAME} PRIVATE -march=native)
endif()

# –ù–∞ Windows —Å–∫–æ–ø–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ DLL (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å) —Ä—è–¥–æ–º —Å exe, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
if(MSVC)
    if(EXISTS "${CMAKE_SOURCE_DIR}/clFFT/lib/x64/clFFT.dll")
        add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${CMAKE_SOURCE_DIR}/clFFT/lib/x64/clFFT.dll"
                "$<TARGET_FILE_DIR:${PROJECT_NAME}>"
        )
    endif()
    if(EXISTS "${CMAKE_SOURCE_DIR}/clFFT/lib/x64/StatTimer.dll")
        add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${CMAKE_SOURCE_DIR}/clFFT/lib/x64/StatTimer.dll"
                "$<TARGET_FILE_DIR:${PROJECT_NAME}>"
        )
    endif()
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 9: –í–´–í–û–î –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –°–ë–û–†–ö–ï
# ============================================================================

message(STATUS "")
message(STATUS "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ:")
message(STATUS "   Platform: ${PLATFORM_NAME}")
message(STATUS "   Compiler: ${CMAKE_CXX_COMPILER}")
message(STATUS "   C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "   Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "   CUDA: ${CUDA_ENABLED}")
message(STATUS "   OpenCL: ${OPENCL_ENABLED}")
message(STATUS "")

# ============================================================================
# –ß–ê–°–¢–¨ 10: –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
# ============================================================================

if(IS_WINDOWS)
    message(STATUS "‚ú® –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ –Ω–∞ Windows:")
    message(STATUS "")
    message(STATUS "   –° CUDA:")
    message(STATUS "   cmake -B build -G \"Visual Studio 17 2022\" -DENABLE_CUDA=ON")
    message(STATUS "   cmake --build build --config Release")
    message(STATUS "")
    message(STATUS "   –ë–µ–∑ CUDA:")
    message(STATUS "   cmake -B build -G \"Visual Studio 17 2022\" -DENABLE_CUDA=OFF")
    message(STATUS "   cmake --build build --config Release")
    message(STATUS "")
else()
    message(STATUS "‚ú® –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ –Ω–∞ Linux/macOS:")
    message(STATUS "")
    message(STATUS "   –° CUDA –∏ Ninja:")
    message(STATUS "   cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_CUDA=ON")
    message(STATUS "   ninja -C build")
    message(STATUS "")
    message(STATUS "   –° OpenCL:")
    message(STATUS "   cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_OPENCL=ON")
    message(STATUS "   ninja -C build")
    message(STATUS "")
    message(STATUS "   –ë–µ–∑ GPU:")
    message(STATUS "   cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_CUDA=OFF")
    message(STATUS "   ninja -C build")
    message(STATUS "")
endif()

# ============================================================================
# –ö–û–ù–ï–¶ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
# ============================================================================

message(STATUS "‚úÖ CMake –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!")
