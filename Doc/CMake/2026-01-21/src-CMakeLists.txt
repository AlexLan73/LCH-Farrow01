# ============================================================================
# Source Directory CMakeLists
# src/CMakeLists.txt
# ============================================================================
# –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ì–ª–∞–≤–Ω–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–º–æ–¥—É–ª–µ–π
# ============================================================================

message(STATUS "")
message(STATUS "üì¶ Processing: src/")
message(STATUS "")

# ============================================================================
# –î–û–ë–ê–í–õ–ï–ù–ò–ï –ü–û–î–ú–û–î–£–õ–ï–ô (–º–æ–¥—É–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞)
# ============================================================================

# 1. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ ManagerOpenCL (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Ä–≤–æ–π, –Ω—É–∂–Ω–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π)
if(OPENCL_ENABLED)
    add_subdirectory(ManagerOpenCL)
endif()

# 2. GPU –º–æ–¥—É–ª—å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç ManagerOpenCL)
if(OPENCL_ENABLED)
    add_subdirectory(GPU)
endif()

# 3. –¢–µ—Å—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
add_subdirectory(Test)

# ============================================================================
# –ì–õ–ê–í–ù–´–ô –ò–°–ü–û–õ–ù–Ø–ï–ú–´–ô –§–ê–ô–õ
# ============================================================================

message(STATUS "üìã Creating main executable: ${PROJECT_NAME}")

set(MAIN_SOURCES
    main.cpp
)

# –ï—Å–ª–∏ OpenCL –≤–∫–ª—é—á–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º GPU-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
if(OPENCL_ENABLED)
    list(APPEND MAIN_SOURCES
        # GPU-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω—ã —á–µ—Ä–µ–∑ include –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        # –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫ –Ω–∏–∂–µ
    )
endif()

# –°–æ–∑–¥–∞—ë–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
add_executable(${PROJECT_NAME} ${MAIN_SOURCES})

# ============================================================================
# –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï INCLUDE –î–ò–†–ï–ö–¢–û–†–ò–ô
# ============================================================================

target_include_directories(${PROJECT_NAME} PRIVATE
    ${CMAKE_SOURCE_DIR}/include
    ${CMAKE_SOURCE_DIR}/include/GPU
    ${CMAKE_SOURCE_DIR}/include/ManagerOpenCL
    ${CMAKE_SOURCE_DIR}/include/interface
)

# ============================================================================
# –õ–ò–ù–ö–û–í–ö–ê –ë–ò–ë–õ–ò–û–¢–ï–ö
# ============================================================================

# –ü–æ–¥–∫–ª—é—á–∞–µ–º ManagerOpenCL –±–∏–±–ª–∏–æ—Ç–µ–∫—É (–µ—Å–ª–∏ –æ–Ω–∞ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–∞)
if(OPENCL_ENABLED)
    target_link_libraries(${PROJECT_NAME} PRIVATE
        lfm_opencl_manager
    )
    message(STATUS "‚úÖ Linked library: lfm_opencl_manager")
endif()

# ============================================================================
# OPENCL & RELATED LIBRARIES
# ============================================================================

if(OPENCL_ENABLED)
    # OpenCL
    target_link_libraries(${PROJECT_NAME} PRIVATE OpenCL::OpenCL)
    target_include_directories(${PROJECT_NAME} PRIVATE ${OpenCL_INCLUDE_DIRS})
    target_compile_definitions(${PROJECT_NAME} PRIVATE OPENCL_ENABLED=1)
    message(STATUS "‚úÖ Linked: OpenCL")
    
    # clFFT
    if(CLFFT_FOUND)
        target_link_libraries(${PROJECT_NAME} PRIVATE "${CLFFT_LIB}")
        target_include_directories(${PROJECT_NAME} PRIVATE "${CLFFT_INCLUDE_DIR}")
        target_compile_definitions(${PROJECT_NAME} PRIVATE CLFFT_FOUND=1)
        message(STATUS "‚úÖ Linked: clFFT")
        
        # Copy DLL on Windows
        if(IS_WINDOWS AND CLFFT_DLL)
            add_custom_command(
                TARGET ${PROJECT_NAME} POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${CLFFT_DLL}"
                "$<TARGET_FILE_DIR:${PROJECT_NAME}>"
                COMMENT "üìã Copying clFFT.dll to output directory"
            )
        endif()
    else()
        target_compile_definitions(${PROJECT_NAME} PRIVATE CLFFT_FOUND=0)
        message(WARNING "‚ö†Ô∏è  clFFT not available - some features may be disabled")
    endif()
    
else()
    target_compile_definitions(${PROJECT_NAME} PRIVATE 
        OPENCL_ENABLED=0
        CLFFT_FOUND=0
    )
endif()

# ============================================================================
# CUDA (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞)
# ============================================================================

if(CUDA_ENABLED)
    enable_language(CUDA)
    set(CMAKE_CUDA_STANDARD 17)
    set(CMAKE_CUDA_STANDARD_REQUIRED ON)
    
    target_link_libraries(${PROJECT_NAME} PRIVATE ${CUDA_LIBRARIES})
    target_include_directories(${PROJECT_NAME} PRIVATE ${CUDA_INCLUDE_DIRS})
    target_compile_definitions(${PROJECT_NAME} PRIVATE CUDA_ENABLED=1)
    
    if(NOT CUDA_ARCH STREQUAL "auto")
        set_target_properties(${PROJECT_NAME} PROPERTIES CUDA_ARCHITECTURES "${CUDA_ARCH}")
    endif()
    
    message(STATUS "‚úÖ Linked: CUDA")
else()
    target_compile_definitions(${PROJECT_NAME} PRIVATE CUDA_ENABLED=0)
endif()

# ============================================================================
# nlohmann_json (Linux only)
# ============================================================================

if(IS_LINUX AND NLOHMANN_JSON_FOUND)
    target_link_libraries(${PROJECT_NAME} PRIVATE nlohmann_json::nlohmann_json)
    message(STATUS "‚úÖ Linked: nlohmann_json")
endif()

# ============================================================================
# STANDARD LIBRARIES
# ============================================================================

if(NOT MSVC)
    target_link_libraries(${PROJECT_NAME} PRIVATE m)
endif()

# ============================================================================
# COMPILER FLAGS
# ============================================================================

if(MSVC)
    target_compile_options(${PROJECT_NAME} PRIVATE /arch:AVX2 /Gy /fp:precise)
else()
    target_compile_options(${PROJECT_NAME} PRIVATE -march=native)
endif()

# ============================================================================
# KERNEL DIRECTORY (–¥–ª—è –ø–æ–∏—Å–∫–∞ .cl —Ñ–∞–π–ª–æ–≤ –≤ runtime)
# ============================================================================

set(OPENCL_KERNEL_DIR "${CMAKE_SOURCE_DIR}/kernels")
target_compile_definitions(${PROJECT_NAME} PRIVATE 
    OPENCL_KERNEL_DIR="${OPENCL_KERNEL_DIR}"
)

# ============================================================================
# COPY RESOURCES
# ============================================================================

# –ö–æ–ø–∏—Ä—É–µ–º JSON —Ñ–∞–π–ª —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –õ–∞–≥—Ä–∞–Ω–∂–∞
if(EXISTS "${CMAKE_SOURCE_DIR}/include/GPU/lagrange_matrix.json")
    add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy
        "${CMAKE_SOURCE_DIR}/include/GPU/lagrange_matrix.json"
        "$<TARGET_FILE_DIR:${PROJECT_NAME}>/lagrange_matrix.json"
        COMMENT "üìã Copying lagrange_matrix.json"
    )
endif()

message(STATUS "‚úÖ Main executable configured: ${PROJECT_NAME}")
message(STATUS "")
